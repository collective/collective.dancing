Channels
========

Channels are a subscription list and configuration. In the user interface they
are called "Mailing-lists".

Setup
-----

  >>> from zope import component
  >>> try:
  ...     from zope.app.component.hooks import setSite
  ... except ImportError:
  ...     from zope.component.hooks import setSite
  >>> setSite(self.portal)

The portal tool
---------------

When installed in a Plone site, we will create a tool called
``portal_newsletters``, and therein a couple of containers:

  >>> sorted(self.portal['portal_newsletters'].objectIds())
  ['channels', 'collectors']

Give me a list of all channels
------------------------------

The ``channels`` folder contains the list of ``IChannel`` available.
These channels can be retrieved through the ``channel_lookup``
function, like so:

  >>> from collective.singing.channel import channel_lookup
  >>> channel_lookup()
  [<Channel at /plone/portal_newsletters/channels/default-channel>]

Let's create another channel and ask for the list of channels again:

  >>> from collective.dancing.channel import Channel
  >>> channels = self.portal['portal_newsletters']['channels']
  >>> channels['wq'] = Channel('wq')
  >>> channel_lookup() # doctest: +NORMALIZE_WHITESPACE
  [<Channel at /plone/portal_newsletters/channels/default-channel>, 
   <Channel at /plone/portal_newsletters/channels/wq>]

Channels and collectors
-----------------------

Our default channel has no collector by default:

  >>> channel = channel_lookup()[0]
  >>> channel.collector is None
  True

We can assign the default collector to our channel like this:

  >>> collectors = self.portal['portal_newsletters']['collectors']
  >>> collector = collectors['default-latest-news']
  >>> channel.collector = collector

Should we now decide to remove the collector, the channel's reference
to the collector will be gone:

  >>> channel.collector
  <Collector at /plone/portal_newsletters/channels/default-channel/default-latest-news>
  >>> collectors.manage_delObjects(['default-latest-news'])
  >>> channel.collector is None
  True

Salt
----

An ISalt utility is created at install time.  It's available for us:

  >>> try:
  ...     from zope.app.component import hooks
  ... except ImportError:
  ...     from zope.component import hooks
  >>> from collective.singing.interfaces import ISalt
  >>> hooks.setSite(portal)
  >>> salt = component.getUtility(ISalt)
  >>> len(salt)
  50

Subscriptions From Script Channel
---------------------------------
Let's create subscriptions from script channel:

  >>> from collective.dancing.channel import SubscriptionsFromScriptChannel
  >>> channels = self.portal['portal_newsletters']['channels']
  >>> channels['external'] = SubscriptionsFromScriptChannel('external')
  >>> channel_lookup() # doctest: +NORMALIZE_WHITESPACE
  [<Channel at /plone/portal_newsletters/channels/default-channel>,
   <Channel at /plone/portal_newsletters/channels/wq>,
   <SubscriptionsFromScriptChannel at /plone/portal_newsletters/channels/external>]

Add python scripts

  >>> from Products.PythonScripts.PythonScript import PythonScript
  >>> ps = PythonScript('ps')
  >>> txt = """return {'composer_data':
  ...     {'organization': u'blah',
  ...     'unsubscribe_url': u'https://localhost:8080/db/pgUnsubscribe?secret=34',
  ...     'my_subscriptions_url': u'https://localhost:8080/db/pgMySubscriptions?secret=34',
  ...     'email': u'test@mail.com',
  ...     'confirm_url': u'https://localhost:8080/db/pgConfirmSubscription?secret=34'},
  ...     'secret': u'34',
  ...     'collector_data':
  ...     {'selected_collectors': [u'news']},
  ...     'metadata':
  ...     {'pending': False,
  ...     'format': 'html'}}"""
  >>> ps.write(txt)
  >>> ps._makeFunction()
  >>> ps._exec({}, (), {})
  {'composer_data': {'organization': u'blah', 'unsubscribe_url': u'https://localhost:8080/db/pgUnsubscribe?secret=34', 'my_subscriptions_url': u'https://localhost:8080/db/pgMySubscriptions?secret=34', 'email': u'test@mail.com', 'confirm_url': u'https://localhost:8080/db/pgConfirmSubscription?secret=34'}, 'secret': u'34', 'collector_data': {'selected_collectors': [u'news']}, 'metadata': {'pending': False, 'format': 'html'}}

  >>> channels['external'].subscriptions
  <SubscriptionsFromScript at /plone/portal_newsletters/channels/external/>

  >>> channels['external'].subscriptions_metadata
  {}

Need to know how to add python script to plone site and assign to SubscriptionsFromScriptChannel script_path

Delete subscriptions from script channel:

  >>> del channels['external']
  >>> channel_lookup() # doctest: +NORMALIZE_WHITESPACE
  [<Channel at /plone/portal_newsletters/channels/default-channel>,
   <Channel at /plone/portal_newsletters/channels/wq>]
